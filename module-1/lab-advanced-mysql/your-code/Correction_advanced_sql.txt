/* Step 1 : Calculate the royalties of each sales for each author */

SELECT titles.title_id AS 'TITLE ID', authors.au_id AS 'AUTHOR ID', COALESCE((titles.price * sales.qty * titles.royalty / 100 * titleauthor.royaltyper / 100), 0) AS 'sales_royalty' 

FROM authors

INNER JOIN titleauthor ON authors.au_id = titleauthor.au_id

LEFT JOIN titles ON titleauthor.title_id= titles.title_id

LEFT JOIN sales ON titles.title_id = sales.title_id
;

/* Step 2 * : Aggregate the total royalties for each title for each author/

SELECT TITLE_ID, AUTHOR_ID, SUM(sales_royalty) AS 'total_royalty'

FROM (
	
SELECT titles.title_id AS 'TITLE_ID', authors.au_id AS 'AUTHOR_ID', COALESCE((titles.price * sales.qty * titles.royalty / 100 * titleauthor.royaltyper / 100), 0) AS 'sales_royalty' 
	
FROM authors
	
INNER JOIN titleauthor ON authors.au_id = titleauthor.au_id
	
LEFT JOIN titles ON titleauthor.title_id= titles.title_id
	
LEFT JOIN sales ON titles.title_id = sales.title_id

)summary

GROUP BY TITLE_ID, AUTHOR_ID;


/* Step 3: Calculate the total profits of each author */

SELECT AUTHOR_ID , ('sales_royalty'+titles.advance) AS `total_profit`

FROM (

SELECT TITLE_ID, AUTHOR_ID, SUM('sales_royalty') AS 'total_royalty'

FROM (

SELECT titles.title_id AS 'TITLE_ID', authors.au_id AS 'AUTHOR_ID', COALESCE((titles.price * sales.qty * titles.royalty / 100 * titleauthor.royaltyper / 100), 0) AS 'sales_royalty' 

FROM authors

INNER JOIN titleauthor ON authors.au_id = titleauthor.au_id

LEFT JOIN titles ON titleauthor.title_id= titles.title_id

LEFT JOIN sales ON titles.title_id = sales.title_id	
	
)summary		

GROUP BY TITLE_ID, AUTHOR_ID
		
	
)summary



GROUP BY AUTHOR_ID, Title_ID,`total_profit`

ORDER BY `total_profit` DESC

limit 3;



/* Solution alternative */
/* Table 1 : Calculate the royalties of each sales for each author */

CREATE TEMPORARY TABLE publications.royalties_sales
SELECT titles.title_id AS title_ID, authors.au_id AS AUTHOR_ID, COALESCE((titles.price * sales.qty * titles.royalty / 100 * titleauthor.royaltyper / 100), 0) AS `sales_royalty`
FROM titles
INNER JOIN titleauthor ON titleauthor.title_id= titles.title_id
LEFT JOIN authors ON authors.au_id = titleauthor.au_id
LEFT JOIN sales ON titles.title_id=sales.title_id

/* Table 2 : Aggregate the total royalties for each title for each author */ 

CREATE TEMPORARY TABLE publications.aggregate_royalties
SELECT title_ID, AUTHOR_ID, SUM(`sales_royalty`) AS 'Total_royalty'
FROM publications.royalties_sales
GROUP BY AUTHOR_ID, title_ID

/* Table 3 : Calculate the total profits of each author and select the top 3 */

SELECT title_id ,AUTHOR_ID, (sale_royalty+titles.advance) AS `Total_profit`
FROM publications.aggregate_royalties
LEFT JOIN publications.titles ON `Title ID` = titles.title_id
GROUP BY AUTHOR_ID, title_ID, Total_profit
ORDER BY `Total_profit` DESC
limit 3;

/* Challenge 3 */ 

DROP TABLE IF EXISTS `most_profiting_authors`;

CREATE TABLE `most_profiting_authors` (
 
 `au_id` char(20) DEFAULT NULL,
  
`profit` decimal(20,5) DEFAULT NULL,
  
CONSTRAINT `fk_authors_id` FOREIGN KEY (`au_id`) REFERENCES publications.authors (`au_id`) ON DELETE CASCADE ON UPDATE CASCADE

) ENGINE=InnoDB DEFAULT CHARSET=utf8;




INSERT INTO `most_profiting_authors`(`au_id`,`profit`)
SELECT `au_id`, (sale_royalty+titles.advance) AS `profit`

FROM (
	
SELECT `Title_ID`,`au_id`,SUM(`sales_royalty`) AS sale_royalty 
	
FROM
	 (
	 
SELECT titles.title_id AS `Title_ID`, authors.au_id AS `au_id`, COALESCE((titles.price * sales.qty * titles.royalty / 100 * titleauthor.royaltyper / 100), 0) AS `sales_royalty`
		
FROM publications.titles
		
INNER JOIN publications.titleauthor ON titleauthor.title_id= titles.title_id
		
LEFT JOIN publications.authors ON authors.au_id = titleauthor.au_id
		
LEFT JOIN publications.sales ON titles.title_id=sales.title_id
		
) summary
	
GROUP BY `Title_ID`,`au_id`
		
)summary
	

LEFT JOIN publications.titles ON `Title_ID` = titles.title_id

GROUP BY `au_id`,`profits`;
